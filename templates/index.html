<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scraped Data Dashboard</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        .navbar-nav .nav-item .nav-link {
            padding-right: 1.5rem;
        }

        .loading-bar {
            width: 100%;
            height: 4px;
            background: #f3f3f3;
            overflow: hidden;
            position: relative;
            display: none; /* Hidden by default */
        }
        .loading-bar div {
            width: 0;
            height: 100%;
            background: #007bff;
            position: absolute;
            animation: loading 2s infinite;
        }
        @keyframes loading {
            0% { left: 0; width: 0; }
            50% { left: 25%; width: 50%; }
            100% { left: 100%; width: 0; }
        }
        .carousel-item {
            display: none;
            justify-content: center;
            align-items: center;
            height: 100%;
            width: 100%;
        }
        .carousel-item.active {
            display: flex;
        }
        .table-container {
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .table {
            width: 80%;
            border-radius: 10px;
            background: linear-gradient(135deg, #f3f3f3, #e6e6e6);
        }
        .carousel-control-prev,
        .carousel-control-next {
            width: 3%;
            filter: invert(100%);
        }
        .carousel-control-prev-icon,
        .carousel-control-next-icon {
            border-radius: 50%;
        }


    </style>
</head>
<body>

<!-- Top Bar with Login and Register -->
<nav class="navbar navbar-expand-lg navbar-light bg-light">
    <a class="navbar-brand" href="#">Data Dashboard</a>
    <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ml-auto">
            <div class="d-flex justify-content-end ">
                <li class="nav-item">
                    <button type="button" class="btn btn-outline-dark btn-lg" data-toggle="modal" data-target="#loginModal">
                        Se connecter
                      </button>
                </li>
                <li class="nav-item">
                    <button type="button" class="btn btn-lg btn-outline-primary active ml-2" data-toggle="modal" data-target="#registerModal">
                        S'inscrire
                      </button>
                </li>
            </div>
           
        </ul>
    </div>
</nav>

<!-- Modal -->
<div class="modal fade" id="loginModal" tabindex="-1" role="dialog" aria-labelledby="loginModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg " style="height: 90%;" role="document">
      <div class="modal-content " style="border-radius: 30px;">
        <div class="modal-header text-center">
          <h2 class="modal-title w-100" id="exampleModalLabel">Se connecter</h2>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <form action="/logIn" method="post">
            <div class="form-group">
                <div class="container">
                    <div class="form-group form-group-lg">
                        <label for="email" style="font-size: 29px;" >Email</label>
                    <input type="email" name="email" id="email" class="form-control form-control-lg" placeholder="test@example.com">
                    <br>
                    
                    <label for="password" style="font-size: 26px;">Mot de passe</label>
                    <input type="password" name="password" id="password" class="form-control form-control-lg" placeholder="Password">
                    <div class="d-flex justify-content-end " > <p class="small mb-5 pb-lg-2"><a class="text-dark" href="#!">Mot de passe oubli√©?</a></p>
                    </div>
                    
                    </div>
                </div>
            </div>
            </div>
            <div class="d-flex justify-content-center mx-auto" style="width: 200px;">
            
                   <input type="submit" data-mdb-button-init data-mdb-ripple-init class="btn btn-outline-dark btn-block mb-4 btn-lg" value="Se connecter" id="">
          </form>
                                        
                </div>
                <div>
                    <p class="d-flex justify-content-center mx-auto" style="width: 300px;">Vous n'avez pas de compte?<span> </span>  <a href="#!" class="text-dark-50 fw-bold"> S'inscrire</a>
                    </p>
                  </div>  
        </div>
        <div class="modal-footer">
            

        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="registerModal" tabindex="-1" role="dialog" aria-labelledby="loginModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
      <div class="modal-content" style="border-radius: 30px;">
        <div class="modal-header text-center">
          <h2 class="modal-title w-100" id="exampleModalLabel">S'inscrire</h2>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <form action="/signUp" method="post">
            <div class="form-group">
                        <div class="container">
                            <label for="email" style="font-size: 26px;" >Email</label>
                            <input type="email" name="email" id="email" class="form-control form-control-lg" placeholder="test@example.com">
                            <br>
                            <label for="nom" style="font-size: 26px;">Nom</label>
                            <input type="text" name="nom" id="nom" class="form-control form-control-lg"placeholder="Nom">
                            <br>
                            <label for="prenom" style="font-size: 26px;">Prenom</label>
                            <input type="text"name="prenom" id="prenom" class="form-control form-control-lg"placeholder="Prenom">
                            <br>
                            <label for="password" style="font-size: 26px;">Mot de passe</label>
                            <input type="password" name="password" id="password" class="form-control form-control-lg"placeholder="Password">
                            <br>
                            <label for="conPassword" style="font-size: 26px;">Confirmer mot de passe</label>
                            <input type="password" name="conPassword" id="conPassword" class="form-control form-control-lg" placeholder="Password">
                            
                        </div>
                </div>
                    </div>
                    <div class="d-flex justify-content-center mx-auto" style="width: 200px;">
                        <input type="submit" data-mdb-button-init data-mdb-ripple-init class="btn btn-outline-dark btn-block mb-4 btn-lg" value="S'inscrire" id="">

                        <br>
                                            
                     </div> 
          </form>
        </div>
        <div class="modal-footer">
            

        </div>
      </div>
    </div>
  </div>
<!-- Loading Bar -->
<div class="loading-bar" id="loading-bar">
    <div></div>
</div>

<!-- Nav Bar for Latest Scraped Data -->
<nav class="navbar navbar-expand-lg navbar-dark bg-dark ml-0 mx-0">
    <div class="scraped-data navbar-nav" id="scraped-data">
        <!-- Links for scraped data items (to be populated dynamically) -->
    </div>
</nav>



<div class="container-fluid mt-4">
    <h2>Scraped Data Tables</h2>

    <div id="carouselExampleDark" class="carousel slide bg-dark" style="border-radius: 30px;" data-ride="carousel">
        <ol class="carousel-indicators" id="carousel-indicators">
            <!-- Indicators will be dynamically added here -->
        </ol>
        <div class="carousel-inner" id="carousel-inner">
            <!-- Carousel items will be dynamically added here -->
        </div>
        <a class="carousel-control-prev" href="#carouselExampleDark" role="button" data-slide="prev">
            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
            <span class="sr-only">Previous</span>
          </a>
          <a class="carousel-control-next" href="#carouselExampleDark" role="button" data-slide="next">
            <span class="carousel-control-next-icon" aria-hidden="true"></span>
            <span class="sr-only">Next</span>
          </a>
    </div>
</div>

</div>
<h2>Radar Chart of Scraped Data</h2>
<div class="container">
<div class="d-flex flex-row justify-content-center ">
    <div class="card border-secondary mx-1" style="border-radius: 11px;">
        
        <div class="loading-bar" id="loading-bar-card1">
            <div></div>
        </div>
        <div class="bg-image hover-overplay"data-mdb-ripple-init data-mdb-ripple-color="dark">
            <div id="radar-chart" class=" mx-auto ml-auto"></div>
            <div class="card-body">
                <h5 class="card-title">Stagiaires.ma</h5>
                <p>Lorem ipsum dolor sit amet consectetur adipisicing elit. Eaque, voluptatibus?</p>
                <a class="btn btn-primary">View</a>
            </div>
        </div>
    </div>
    <div class="card border-secondary ml-1" style="border-radius: 11px;">
        <div class="loading-bar" id="loading-bar-card2" >
            <div></div>
        </div>
        <div class="bg-image hover-overplay" data-mdb-ripple-init data-mdb-ripple-color="light">
            <div id="radar-chart-MA" class=" mx-auto ml-auto"></div>
            <div class="card-body">
                <h5 class="card-title">MarocAnnonces.ma</h5>
                <p>Lorem ipsum dolor sit amet consectetur adipisicing elit. Eaque, voluptatibus?</p>
                <a class="btn btn-primary">View</a>
            </div>
        </div>
    </div>
</div>
</div>
<div class="container-fluid mt-4">

   
<script>
    let maxHeight = 0;

    function fetchLatestData() {
        const loadingBar = document.getElementById('loading-bar');
        const slidesContainer = document.getElementById('carousel-inner');
        const indicatorsContainer = document.getElementById('carousel-indicators');
        loadingBar.style.display = 'block'; // Show loading bar
        fetch('/latest-data')
            .then(response => response.json())
            .then(dataItems => {
                if (Array.isArray(dataItems) && dataItems.length > 0) {
                    dataItems.forEach((siteData, index) => {
                        if (Array.isArray(siteData) && siteData.length > 0) {
                            const carouselItem = document.createElement('div');
                            carouselItem.classList.add('carousel-item');
                            if (index === 0) {
                                carouselItem.classList.add('active');
                            }

                            const fields = Object.keys(siteData[0]);
                            const table = document.createElement('table');
                            table.classList.add('table', 'table-bordered', 'table-striped');

                            // Create table header
                            const thead = document.createElement('thead');
                            const headerRow = document.createElement('tr');
                            fields.forEach(field => {
                                const th = document.createElement('th');
                                th.textContent = field;
                                headerRow.appendChild(th);
                            });
                            thead.appendChild(headerRow);
                            table.appendChild(thead);

                            // Create table body
                            const tbody = document.createElement('tbody');
                            siteData.forEach(item => {
                                const row = document.createElement('tr');
                                fields.forEach(field => {
                                    const cell = document.createElement('td');
                                    if (field === 'Lien') {
                                        const linkButton = document.createElement('a');
                                        linkButton.href = item[field];
                                        linkButton.textContent = 'View';
                                        linkButton.classList.add('btn', 'btn-primary');
                                        cell.appendChild(linkButton);
                                    } else {
                                        cell.textContent = item[field];
                                    }
                                    row.appendChild(cell);
                                });
                                tbody.appendChild(row);
                            });
                            table.appendChild(tbody);
                            carouselItem.appendChild(table);
                            slidesContainer.appendChild(carouselItem);

                            // Add carousel indicator
                            const indicator = document.createElement('li');
                            indicator.setAttribute('data-target', '#carouselExampleDark');
                            indicator.setAttribute('data-slide-to', index);

                            indicatorsContainer.appendChild(indicator);

                            // Calculate max height
                            const tableHeight = carouselItem.offsetHeight;
                            if (tableHeight > maxHeight) {
                                maxHeight = tableHeight;
                            }
                        } else {
                            console.error('Invalid siteData:', siteData);
                        }
                    });

                    // Apply max height to all tables
                    document.querySelectorAll('.table-container').forEach(container => {
                        container.style.height = maxHeight + 'px';
                    });
                } else {
                    console.error('Invalid dataItems:', dataItems);
                }
                loadingBar.style.display = 'none'; // Hide loading bar
            })
            .catch(error => {
                console.error('Error fetching latest data:', error);
                loadingBar.style.display = 'none'; // Hide loading bar on error
            });
    }

    function fetchGraphData() {
        const loadingBar2 = document.getElementById('loading-bar-card1');
        loadingBar2.style.display = 'block'; // Show loading bar
        fetch('/graph-data-demandes')
            .then(response => response.json())
            .then(data => {
                const domains = {};
                data.forEach(item => {
                    if (domains[item.Secteur]) {
                        domains[item.Secteur]++;
                    } else {
                        domains[item.Secteur] = 1;
                    }
                });

                const radarData = [{
                    type: 'scatterpolar',
                    r: Object.values(domains),
                    theta: Object.keys(domains),
                    fill: 'toself',
                    name: 'Secteur'
                }];

                const layout = {
                    polar: {
                        radialaxis: {
                            visible: true,
                            range: [0, Math.max(...Object.values(domains))]
                        }
                    }
                };

                Plotly.newPlot('radar-chart', radarData, layout);
                loadingBar2.style.display = 'none'; // Hide loading bar

            })
            .catch(error => console.error('Error fetching graph data:', error));

    }
    function fetchGraphDataMA() {
        const loadingBar2 = document.getElementById('loading-bar-card2');
        loadingBar2.style.display = 'block'; // Show loading bar
        fetch('/graph-data-demandesMA')
            .then(response => response.json())
            .then(data => {
                const domains = {};
                data.forEach(item => {
                    if (domains[item.Domaine]) {
                        domains[item.Domaine]++;
                    } else {
                        domains[item.Domaine] = 1;
                    }
                });

                const radarData = [{
                    type: 'scatterpolar',
                    r: Object.values(domains),
                    theta: Object.keys(domains),
                    fill: 'toself',
                    name: 'Domaine'
                }];

                const layout = {
                    polar: {
                        radialaxis: {
                            visible: true,
                            range: [0, Math.max(...Object.values(domains))]
                        }
                    }
                };

                Plotly.newPlot('radar-chart-MA', radarData, layout);
                loadingBar2.style.display = 'none'; // Hide loading bar
            })
            .catch(error => console.error('Error fetching graph data:', error));

    }

    document.addEventListener('DOMContentLoaded', function() {
        fetchGraphDataMA();
        
        fetchLatestData();
        fetchGraphData();
    });
</script>

<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.3/dist/umd/popper.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"></script>
<script src='https://kit.fontawesome.com/a076d05399.js' crossorigin='anonymous'></script>

</body>
</html>
