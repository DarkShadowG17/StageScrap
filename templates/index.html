<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scraped Data Dashboard</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        .navbar-nav .nav-item .nav-link {
            padding-right: 1.5rem;
        }
        .loading-bar {
            width: 100%;
            height: 4px;
            background: #f3f3f3;
            overflow: hidden;
            position: relative;
            display: none; /* Hidden by default */
        }
        .loading-bar div {
            width: 0;
            height: 100%;
            background: #007bff;
            position: absolute;
            animation: loading 2s infinite;
        }
        @keyframes loading {
            0% { left: 0; width: 0; }
            50% { left: 25%; width: 50%; }
            100% { left: 100%; width: 0; }
        }
        .carousel-item {
            display: none;
            justify-content: center;
            align-items: center;
            height: 100%;
            width: 100%;
        }
        .carousel-item.active {
            display: flex;
        }
        .table-container {
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .table {
            width: 80%;
            border-radius: 10px;
            background: linear-gradient(135deg, #f3f3f3, #e6e6e6);
        }
        .carousel-control-prev,
        .carousel-control-next {
            width: 3%;
            filter: invert(100%);
        }
        .carousel-control-prev-icon,
        .carousel-control-next-icon {
            border-radius: 50%;
        }

    </style>
</head>
<body>

<!-- Top Bar with Login and Register -->
<nav class="navbar navbar-expand-lg navbar-light bg-light">
    <a class="navbar-brand" href="#">Data Dashboard</a>
    <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ml-auto">
            <li class="nav-item">
                <a class="nav-link" href="/login">Log In</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="/register">Register</a>
            </li>
        </ul>
    </div>
</nav>

<!-- Loading Bar -->
<div class="loading-bar" id="loading-bar">
    <div></div>
</div>

<!-- Nav Bar for Latest Scraped Data -->
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="scraped-data navbar-nav" id="scraped-data">
        <!-- Links for scraped data items (to be populated dynamically) -->
    </div>
</nav>



<div class="container-fluid mt-4">
    <h2>Scraped Data Tables</h2>
    <div id="carouselExampleDark" class="carousel slide bg-dark" data-ride="carousel">
        <ol class="carousel-indicators" id="carousel-indicators">
            <!-- Indicators will be dynamically added here -->
        </ol>
        <div class="carousel-inner" id="carousel-inner">
            <!-- Carousel items will be dynamically added here -->
        </div>
        <a class="carousel-control-prev" href="#carouselExampleDark" role="button" data-slide="prev">
            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
            <span class="sr-only">Previous</span>
          </a>
          <a class="carousel-control-next" href="#carouselExampleDark" role="button" data-slide="next">
            <span class="carousel-control-next-icon" aria-hidden="true"></span>
            <span class="sr-only">Next</span>
          </a>
    </div>
</div>
<div class="container mt-4">
    <h2>Graphs of Scraped Data</h2>
    <div id="plotly-graph"></div>
</div>
<script>
    let maxHeight = 0;

    function fetchLatestData() {
        const loadingBar = document.getElementById('loading-bar');
        const slidesContainer = document.getElementById('carousel-inner');
        const indicatorsContainer = document.getElementById('carousel-indicators');
        loadingBar.style.display = 'block'; // Show loading bar
        fetch('/latest-data')
            .then(response => response.json())
            .then(dataItems => {
                if (Array.isArray(dataItems) && dataItems.length > 0) {
                    dataItems.forEach((siteData, index) => {
                        if (Array.isArray(siteData) && siteData.length > 0) {
                            const carouselItem = document.createElement('div');
                            carouselItem.classList.add('carousel-item');
                            if (index === 0) {
                                carouselItem.classList.add('active');
                            }

                            const fields = Object.keys(siteData[0]);
                            const table = document.createElement('table');
                            table.classList.add('table', 'table-bordered', 'table-striped');

                            // Create table header
                            const thead = document.createElement('thead');
                            const headerRow = document.createElement('tr');
                            fields.forEach(field => {
                                const th = document.createElement('th');
                                th.textContent = field;
                                headerRow.appendChild(th);
                            });
                            thead.appendChild(headerRow);
                            table.appendChild(thead);

                            // Create table body
                            const tbody = document.createElement('tbody');
                            siteData.forEach(item => {
                                const row = document.createElement('tr');
                                fields.forEach(field => {
                                    const cell = document.createElement('td');
                                    if (field === 'Lien') {
                                        const linkButton = document.createElement('a');
                                        linkButton.href = item[field];
                                        linkButton.textContent = 'View';
                                        linkButton.classList.add('btn', 'btn-primary');
                                        cell.appendChild(linkButton);
                                    } else {
                                        cell.textContent = item[field];
                                    }
                                    row.appendChild(cell);
                                });
                                tbody.appendChild(row);
                            });
                            table.appendChild(tbody);
                            carouselItem.appendChild(table);
                            slidesContainer.appendChild(carouselItem);

                            // Add carousel indicator
                            const indicator = document.createElement('li');
                            //indicator.type = 'button';
                            indicator.setAttribute('data-target', '#carouselExampleDark');
                            indicator.setAttribute('data-slide-to', index);
                            //indicator.setAttribute('aria-label', `Slide ${index + 1}`);
                            // if (index === 0) {
                            //     indicator.classList.add('active');
                            //     //indicator.setAttribute('aria-current', 'true');
                            // }
                            indicatorsContainer.appendChild(indicator);

                            // Calculate max height
                            const tableHeight = carouselItem.offsetHeight;
                            if (tableHeight > maxHeight) {
                                maxHeight = tableHeight;
                            }
                        } else {
                            console.error('Invalid siteData:', siteData);
                        }
                    });

                    // Apply max height to all tables
                    document.querySelectorAll('.table-container').forEach(container => {
                        container.style.height = maxHeight + 'px';
                    });
                } else {
                    console.error('Invalid dataItems:', dataItems);
                }
                loadingBar.style.display = 'none'; // Hide loading bar
            })
            .catch(error => {
                console.error('Error fetching latest data:', error);
                loadingBar.style.display = 'none'; // Hide loading bar on error
            });
    }

    function fetchGraphData() {
        fetch('/graph-data')
            .then(response => response.json())
            .then(graphJSON => {
                const graph = JSON.parse(graphJSON);
                Plotly.newPlot('plotly-graph', graph.data, graph.layout);
            });
    }

    document.addEventListener('DOMContentLoaded', function() {
        fetchLatestData();
        fetchGraphData();
    });
</script>

<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.9.3/dist/umd/popper.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
